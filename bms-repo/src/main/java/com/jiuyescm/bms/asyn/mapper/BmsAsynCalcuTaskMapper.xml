<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskMapper" >
    <resultMap id="baseResultMap" type="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskEntity" >
        <id column="id" property="id" jdbcType="BIGINT" />
	    <result column="id" property="id" jdbcType="BIGINT" />
	    <result column="task_id" property="taskId" jdbcType="VARCHAR" />
	    <result column="customer_id" property="customerId" jdbcType="VARCHAR" />
	    <result column="customer_name" property="customerName" jdbcType="VARCHAR" />
	    <result column="subject_code" property="subjectCode" jdbcType="VARCHAR" />
	    <result column="subject_name" property="subjectName" jdbcType="VARCHAR" />
	    <result column="fees_type" property="feesType" jdbcType="VARCHAR" />
	    <result column="cre_month" property="creMonth" jdbcType="INTEGER" />
	    <result column="task_status" property="taskStatus" jdbcType="TINYINT" />
	    <result column="fees_count" property="feesCount" jdbcType="INTEGER" />
	    <result column="uncalcu_count" property="uncalcuCount" jdbcType="INTEGER" />
	    <result column="calcu_count" property="calcuCount" jdbcType="INTEGER" />
	    <result column="begin_count" property="beginCount" jdbcType="INTEGER" />
	    <result column="finish_count" property="finishCount" jdbcType="INTEGER" />
	    <result column="sys_error_count" property="sysErrorCount" jdbcType="INTEGER" />
	    <result column="contract_miss_count" property="contractMissCount" jdbcType="INTEGER" />
	    <result column="quote_miss_count" property="quoteMissCount" jdbcType="INTEGER" />
	    <result column="no_exe_count" property="noExeCount" jdbcType="INTEGER" />
	    <result column="task_rate" property="taskRate" jdbcType="INTEGER" />
	    <result column="cre_person" property="crePerson" jdbcType="VARCHAR" />
	    <result column="cre_person_id" property="crePersonId" jdbcType="VARCHAR" />
	    <result column="cre_time" property="creTime" jdbcType="TIMESTAMP" />
	    <result column="process_time" property="processTime" jdbcType="TIMESTAMP" />
	    <result column="finish_time" property="finishTime" jdbcType="TIMESTAMP" />
	    <result column="remark" property="remark" jdbcType="VARCHAR" />
    </resultMap>
  
    <sql id="baseColumns">
        id, task_id, customer_id,customer_name, subject_code,subject_name,fees_type, cre_month, task_status, fees_count, uncalcu_count, calcu_count, begin_count, finish_count, sys_error_count, contract_miss_count, quote_miss_count, no_exe_count, task_rate, cre_person, cre_person_id, cre_time, process_time, finish_time, remark
    </sql>
	
	<sql id="baseSelectColumns">
		<if test="(taskId != null and taskId !='')" >
				and task_id = #{taskId}
		</if>
		<if test="(customerId != null and customerId !='')" >
				and customer_id = #{customerId}
		</if>
		<if test="(subjectCode != null and subjectCode !='')" >
				and subject_code = #{subjectCode}
		</if>
		<if test="(creMonth != null)" >
				and cre_month = #{creMonth}
		</if>
		<if test="(taskStatus != null)" >
				and task_status = #{taskStatus}
		</if>
		<if test="(crePerson != null and crePerson !='')" >
				and cre_person = #{crePerson}
		</if>
		<if test="(crePersonId != null and crePersonId !='')" >
				and cre_person_id = #{crePersonId}
		</if>
		<if test="(creTime != null and creTime !='')" >
			    and cre_time >= #{creTime} and <![CDATA[cre_time <= #{creTime}]]>
		</if>
		<if test="(feesType != null and feesType !='')" >
				and fees_type = #{feesType}
		</if>
    </sql>
	  
    <select id="query" parameterType="java.util.Map"
        resultType="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskEntity">
        select
        <include refid="baseColumns" />
        from bms_asyn_calcu_task
        where 1=1
		<include refid="baseSelectColumns" />
		<if test="(queryCus != null and queryCus !='')" >
				group by customer_id
		</if>
    </select>
    
    <select id="queryOne" parameterType="java.lang.String"
        resultType="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskEntity">
        select
        <include refid="baseColumns" />
        from bms_asyn_calcu_task
        where 1=1 and task_id= #{taskId} limit 1
		
    </select>


    <insert id="save" parameterType="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskEntity">
        insert into bms_asyn_calcu_task
        (task_id, customer_id, customer_name,subject_code,subject_name, fees_type, cre_month, task_status, cre_person, cre_person_id, cre_time,remark)
        values (
			#{taskId,jdbcType=VARCHAR}, 
			#{customerId,jdbcType=VARCHAR}, 
			#{customerName,jdbcType=VARCHAR}, 
			#{subjectCode,jdbcType=VARCHAR},
			#{subjectName,jdbcType=VARCHAR}, 
			#{feesType,jdbcType=VARCHAR}, 
			#{creMonth,jdbcType=INTEGER}, 
			#{taskStatus,jdbcType=TINYINT}, 
			#{crePerson,jdbcType=VARCHAR}, 
			#{crePersonId,jdbcType=VARCHAR}, 
			#{creTime,jdbcType=TIMESTAMP},  
			#{remark,jdbcType=VARCHAR}
        )
    </insert>

    <update id="update" parameterType="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskEntity">
        update bms_asyn_calcu_task 
		<set >
			<if test="taskStatus != null" >task_status=#{taskStatus,jdbcType=TINYINT},</if>
			<if test="calcuStatus != null" >calcu_status=#{calcuStatus,jdbcType=TINYINT},</if>
			<if test="feesCount != null" >fees_count=#{feesCount,jdbcType=INTEGER},</if>
			<if test="uncalcuCount != null" >uncalcu_count=#{uncalcuCount,jdbcType=INTEGER},</if>
			<if test="calcuCount != null" >calcu_count=#{calcuCount,jdbcType=INTEGER},</if>
			<if test="beginCount != null" >begin_count=#{beginCount,jdbcType=INTEGER},</if>
			<if test="finishCount != null" >finish_count=#{finishCount,jdbcType=INTEGER},</if>
			<if test="sysErrorCount != null" >sys_error_count=#{sysErrorCount,jdbcType=INTEGER},</if>
			<if test="contractMissCount != null" >contract_miss_count=#{contractMissCount,jdbcType=INTEGER},</if>
			<if test="quoteMissCount != null" >quote_miss_count=#{quoteMissCount,jdbcType=INTEGER},</if>
			<if test="noExeCount != null" >no_exe_count=#{noExeCount,jdbcType=INTEGER},</if>
			<if test="taskRate != null" >task_rate=#{taskRate,jdbcType=INTEGER},</if>
			<if test="processTime != null" >process_time=#{processTime,jdbcType=TIMESTAMP},</if>
			<if test="finishTime != null" >finish_time=#{finishTime,jdbcType=TIMESTAMP},</if>
			<if test="remark != null" >remark=#{remark,jdbcType=VARCHAR},</if>
		</set>
        where task_id=#{taskId}
    </update>
    
    <select id="queryUnfinish" parameterType="java.util.Map"
        resultType="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskEntity">
        select
        <include refid="baseColumns" />
        from bms_asyn_calcu_task
        where 1=1 and task_status in(0,10)
		<include refid="baseSelectColumns" />
    </select>
    
    <select id="queryByMap" parameterType="java.util.Map"
        resultType="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskEntity">
        select customer_id as customerId,subject_code as subjectCode, DATE_FORMAT(create_time,'%Y%m') as creMonth
		from fees_receive_storage 
   		where del_flag='0' and is_calculated=#{isCalculated}
    	<if test="(subjectList != null and subjectList!='')">
			and subject_code in
			<foreach collection="subjectList" index="index" item="item" open="(" separator="," close=")">
				#{item}
		    </foreach>
		</if>  	
		GROUP BY customer_id,subject_code,DATE_FORMAT(create_time,'%Y%m');  
    </select>
    
    <select id="queryDisByMap" parameterType="java.util.Map"
        resultType="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskEntity">
        select customerid as customerId,subject_code as subjectCode,DATE_FORMAT(create_time,'%Y%m') as creMonth
		from fees_receive_dispatch
		where is_calculated=#{isCalculated}
		and del_flag='0'
    	<if test="(subjectList != null and subjectList!='')">
			and subject_code in
			<foreach collection="subjectList" index="index" item="item" open="(" separator="," close=")">
				#{item}
		    </foreach>
		</if>  	
		GROUP BY customerid,subject_code,DATE_FORMAT(create_time,'%Y%m');  
    </select>
    
        <insert id="saveLog" parameterType="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskEntity">
        insert into bms_asyn_calcu_task_log
        (task_id, customer_id, customer_name,subject_code,subject_name, fees_type, cre_month, task_status, cre_person, cre_person_id, cre_time,remark)
        values (
			#{taskId,jdbcType=VARCHAR}, 
			#{customerId,jdbcType=VARCHAR}, 
			#{customerName,jdbcType=VARCHAR}, 
			#{subjectCode,jdbcType=VARCHAR},
			#{subjectName,jdbcType=VARCHAR}, 
			#{feesType,jdbcType=VARCHAR}, 
			#{creMonth,jdbcType=INTEGER}, 
			#{taskStatus,jdbcType=TINYINT}, 
			#{crePerson,jdbcType=VARCHAR}, 
			#{crePersonId,jdbcType=VARCHAR}, 
			#{creTime,jdbcType=TIMESTAMP},  
			#{remark,jdbcType=VARCHAR}
        )
    </insert>
    <select id="queryMain" parameterType="java.util.Map"
    	resultType="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskEntity">
    	select customer_id,customer_name,cre_month
		from bms_asyn_calcu_task 
		where cre_month = #{creMonth} 
		and task_status >=0 
		and <![CDATA[task_status <= 30]]>
		<if test="(customerId != null and customerId!='')">
			and customer_id = #{customerId}	
		</if>
		group by customer_id,customer_name
    </select>
    
    <select id="queryInfoByCustomerId" parameterType="java.util.Map"
    	resultType="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskEntity">
    	select customer_id,customer_name,cre_month,max(subject_status) as customerStatus,count(0) as subjectNum from 
		(select customer_id,customer_name,cre_month,task_status,
			case 
			when task_status = 0 then '2'
			when task_status = 10 then '2'
			when task_status = 20 then '1'
			when task_status = 30 then '3'
			end subject_status
			from bms_asyn_calcu_task 
			where cre_month = #{creMonth}
			and task_status >=0 
			and <![CDATA[task_status <= 30]]>
			<if test="(customerIds != null and customerIds!='')">
				and customer_id in
				<foreach collection="customerIds" index="index" item="item" open="(" separator="," close=")">
					#{item}
			    </foreach>
			</if>  
		) t
		group by t.customer_id,t.customer_name
		<if test="customerStatus != null and customerStatus !='' and customerStatus != 'ALL' ">
			HAVING customerStatus=#{customerStatus}
		</if>
    </select>
    
    <select id="queryDetail" parameterType="java.util.Map"
    	resultType="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskEntity">
    	select subject_code,subject_name,fees_type,customer_id,customer_name,cre_month,task_status,fees_count,
		finish_count,contract_miss_count,quote_miss_count,uncalcu_count,
		sys_error_count,no_exe_count,
		case 
		when task_status = 0 then '2'
		when task_status = 10 then '2'
		when task_status = 20 then '1'
		when task_status = 30 then '3'
		end customerStatus 
		from bms_asyn_calcu_task 
		where cre_month = #{creMonth} 
		and task_status >=0 
		and <![CDATA[task_status <= 30]]>
		<if test="(customerId != null and customerId!='')">
			and customer_id = #{customerId}
		</if>
    </select>
    
        <update id="updateByTaskId" parameterType="com.jiuyescm.bms.asyn.entity.BmsAsynCalcuTaskEntity">
        update bms_asyn_calcu_task 
		<set >
			<if test="taskStatus != null" >task_status=#{taskStatus,jdbcType=TINYINT},</if>
			<if test="feesCount != null" >fees_count=#{feesCount,jdbcType=INTEGER},</if>
			<if test="uncalcuCount != null" >uncalcu_count=#{uncalcuCount,jdbcType=INTEGER},</if>
			<if test="calcuCount != null" >calcu_count=#{calcuCount,jdbcType=INTEGER},</if>
			<if test="beginCount != null" >begin_count=#{beginCount,jdbcType=INTEGER},</if>
			<if test="finishCount != null" >finish_count=#{finishCount,jdbcType=INTEGER},</if>
			<if test="sysErrorCount != null" >sys_error_count=#{sysErrorCount,jdbcType=INTEGER},</if>
			<if test="contractMissCount != null" >contract_miss_count=#{contractMissCount,jdbcType=INTEGER},</if>
			<if test="quoteMissCount != null" >quote_miss_count=#{quoteMissCount,jdbcType=INTEGER},</if>
			<if test="noExeCount != null" >no_exe_count=#{noExeCount,jdbcType=INTEGER},</if>
			<if test="taskRate != null" >task_rate=#{taskRate,jdbcType=INTEGER},</if>
			<if test="processTime != null" >process_time=#{processTime,jdbcType=TIMESTAMP},</if>
			<if test="finishTime != null" >finish_time=#{finishTime,jdbcType=TIMESTAMP},</if>
			<if test="remark != null" >remark=#{remark,jdbcType=VARCHAR},</if>
			<if test="taskId != null" >task_id=#{taskId,jdbcType=VARCHAR},</if>
		</set>
        where task_id=#{taskId}
    </update>
</mapper>